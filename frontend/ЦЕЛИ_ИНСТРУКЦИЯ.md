# Функционал "Цели" - Инструкция по использованию

## Обзор

В приложение FamilyCoins добавлен полнофункциональный модуль для работы с целями, который позволяет детям и родителям создавать, отслеживать и управлять различными типами целей.

## Возможности

### Для детей:
- ✅ Создание личных целей
- ✅ Просмотр прогресса выполнения
- ✅ Автоматическое обновление прогресса при выполнении заданий и изменении баланса
- ✅ Создание целей для накопления на товары из магазина

### Для родителей:
- ✅ Создание целей для любого ребенка
- ✅ Просмотр всех целей семьи, сгруппированных по детям
- ✅ Управление целями (приостановка, возобновление, удаление)
- ✅ Создание целей прямо из товаров магазина
- ✅ Детальный просмотр целей в профиле ребенка

## Типы целей

### 1. Накопление монет (`coin_saving`)
- Цель накопить определенное количество монет
- Автоматически обновляется при изменении баланса
- Пример: "Накопить 500 монет на новую игру"

### 2. Товар из магазина (`store_item`)
- Цель накопить на конкретный товар
- Создается автоматически с правильной суммой
- Связана с товаром из семейного магазина

### 3. Выработка привычки (`habit_building`)
- Цель выполнить определенное задание N дней подряд
- Связана с конкретным шаблоном задания
- Отслеживает серии выполнения (streak)
- Пример: "Заправлять кровать 30 дней подряд"

### 4. Смешанная цель (`mixed`)
- Комбинация нескольких условий с весами
- Более сложная настройка (пока через API)

## Как использовать

### Создание цели (дети):
1. Перейти в раздел "Цели"
2. Нажать "Создать цель"
3. Выбрать тип цели
4. Заполнить детали и условия
5. Установить срок выполнения (опционально)
6. Указать бонусные монеты за достижение

### Создание цели (родители):
1. Перейти в раздел "Цели"
2. Выбрать вкладку "Цели семьи" или "Создать для ребенка"
3. Нажать "Создать цель"
4. Выбрать ребенка из списка
5. Настроить цель аналогично детскому интерфейсу

### Создание цели из магазина:
1. Перейти в раздел "Магазин"
2. Найти нужный товар
3. Нажать кнопку "Цель" рядом с товаром
4. Для родителей - выбрать ребенка
5. Цель создается автоматически с правильной суммой

### Отслеживание прогресса:
- Прогресс отображается в виде полосы загрузки
- Процент выполнения показывается рядом
- Детали по каждому условию доступны при клике на цель

### Управление целями (родители):
- Приостановка цели: временно останавливает отслеживание
- Возобновление: продолжает отслеживание с текущего прогресса
- Удаление: окончательно удаляет цель

## Автоматизация

### Обновление прогресса:
- **Монеты**: при начислении/списании автоматически обновляются цели типа `coin_saving`
- **Задания**: при одобрении заданий обновляются цели типа `habit_building`
- **Завершение**: при достижении всех условий цель автоматически завершается
- **Бонусы**: при завершении цели автоматически начисляются бонусные монеты

### Интеграция с существующим функционалом:
- Цели отображаются в профиле ребенка (для родителей)
- Кнопки создания целей в магазине
- Связь с системой заданий и монет

## API интеграция

Реализованы все основные эндпоинты из технической документации:
- `GET /v1/goals` - получение целей
- `POST /v1/goals` - создание цели
- `PUT /v1/goals/{id}` - обновление цели
- `DELETE /v1/goals/{id}` - удаление цели
- `POST /v1/goals/{id}/pause` - приостановка
- `POST /v1/goals/{id}/resume` - возобновление
- `POST /v1/store/items/{id}/create-goal` - создание цели для товара

## Дизайн и UX

### Визуальные элементы:
- Красивые карточки целей с градиентами по статусам
- Анимированные полосы прогресса
- Иконки для разных типов целей
- Цветовая индикация статусов (активная, завершенная, приостановленная)

### Адаптивность:
- Мобильная версия с вертикальной раскладкой
- Responsive дизайн для всех размеров экранов
- Touch-friendly интерфейс

## Тестирование

### Базовые сценарии для проверки:

1. **Создание цели ребенком**:
   - Войти как ребенок
   - Создать цель "Накопить 100 монет"
   - Проверить отображение в разделе "Цели"

2. **Создание цели родителем**:
   - Войти как родитель
   - Создать цель для ребенка
   - Проверить отображение в семейных целях

3. **Прогресс цели**:
   - Выполнить задание или получить монеты
   - Проверить обновление прогресса цели

4. **Цель из магазина**:
   - Создать товар в магазине
   - Создать цель для этого товара
   - Проверить правильность суммы

5. **Управление целями**:
   - Приостановить цель
   - Возобновить цель
   - Удалить цель

## Файлы, которые были изменены/добавлены:

### HTML:
- `index.html` - добавлен раздел целей и модальные окна
- `dashboard.html` - добавлен раздел целей и модальные окна

### JavaScript:
- `app.js` - добавлен класс `Goals` с полным функционалом
- Обновлены классы `Store`, `ChildProfile` для интеграции с целями
- Добавлены новые функции для модальных окон

### CSS:
- `styles.css` - добавлены стили для целей (400+ строк CSS)
- Адаптивные стили для мобильных устройств

### Документация:
- `ЦЕЛИ_ИНСТРУКЦИЯ.md` - данная инструкция

## Исправление ошибки "Referenced task not found"

### Проблема:
При создании цели типа "выработка привычки" возникала ошибка `Referenced task not found: [uuid]` из-за того, что система пыталась найти шаблон задания (`TaskTemplate`) в таблице активных заданий (`Task`).

### Решение:
Изменен механизм загрузки данных для целей-привычек:
- Теперь загружаются **активные задания семьи** вместо шаблонов
- Для родителей: загружаются созданные ими задания
- Для детей: загружаются назначенные им задания
- Добавлено предупреждение, если нет доступных заданий

### Что изменилось:
1. Метод `loadRequiredData()` теперь загружает задания через `/tasks/my`
2. Добавлена проверка наличия заданий перед отображением формы
3. Улучшена валидация и пользовательский опыт

## Заключение

Функционал целей полностью интегрирован в существующее приложение и готов к использованию. Все основные возможности реализованы согласно технической документации backend с добавлением удобного и красивого пользовательского интерфейса.

### ✅ Исправлено:
- Ошибка создания целей-привычек
- Корректная привязка к активным заданиям
- Улучшенная валидация форм
